# Module 6: Advanced EF & API Integration

## ğŸ“‹ Overview

This module advances Entity Framework Core concepts by implementing complex entity relationships and API integration patterns. You'll learn to create hierarchical data models, implement dependency injection with DbContext, and build APIs that work with related entities efficiently.

## ğŸ¯ Learning Objectives

- Implement complex entity relationships (one-to-many with collections)
- Create APIs with Entity Framework integration using dependency injection
- Design hierarchical data models (Boards containing Todos)
- Implement data seeding strategies for development
- Use Include strategies for loading related entities
- Build scalable service layer patterns
- Handle entity creation with nested relationships

## ğŸ“ Project Structure

```
module6/
â”œâ”€â”€ Program.cs                  # API application entry point
â”œâ”€â”€ module6.csproj             # Project configuration
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ BoardContext.cs        # DbContext for board/todo system
â”œâ”€â”€ Service/
â”‚   â””â”€â”€ DataService.cs         # Business logic and data operations
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ Board.cs              # Board entity (contains todos)
â”‚   â”œâ”€â”€ Todo.cs               # Todo entity with user assignment
â”‚   â””â”€â”€ User.cs               # User entity
â”œâ”€â”€ appsettings.json          # Application configuration
â””â”€â”€ appsettings.Development.json # Development-specific settings
```

## ğŸ—ï¸ Entity Models

### Board Entity (`Board.cs`)

Represents a project board that contains multiple todos:

```csharp
namespace module6.model
{
    public class Board
    {
        public Board()
        {
        }
        
        public Board(List<Todo> todos)
        {
            this.todos = todos;
        }

        public long BoardId { get; set; }           // Primary key
        public List<Todo> todos { get; set; }       // Navigation property (one-to-many)
    }
}
```

**Key Features:**
- **Primary Key**: `BoardId` (auto-generated by EF Core)
- **Collection Navigation**: One-to-many relationship with todos
- **Multiple Constructors**: Default constructor for EF Core, parameterized for business logic
- **Hierarchical Design**: Board acts as a container for related todos

### Todo Entity (`Todo.cs`)

Represents individual tasks within a board with user assignment:

```csharp
namespace module6.model
{
    public class Todo
    {
        public Todo()
        {
        }
        
        public Todo(string text, string category, User user)
        {
            this.Text = text;
            this.Category = category;
            this.user = user;
        }
        
        public long UserId { get; set; }        // Primary key
        public string? Text { get; set; }       // Todo description
        public string? Category { get; set; }   // Todo category
        public User user { get; set; }          // Navigation property to User
    }
}
```

**Key Features:**
- **Composite Structure**: Combines text, category, and user assignment
- **User Relationship**: Each todo is assigned to a specific user
- **Flexible Construction**: Constructor accepts essential business data
- **Nullable Properties**: Text and Category can be null for flexibility

### User Entity (`User.cs`)

Simple user representation for todo assignment:

```csharp
public class User
{
    public long UserId { get; set; }       // Primary key
    public string? Username { get; set; }  // User identifier
}
```

**Key Features:**
- **Minimal Design**: Contains only essential user information
- **Primary Key**: Auto-generated UserId
- **Nullable Username**: Allows for flexible user creation

## ğŸ—„ï¸ Database Context (`BoardContext.cs`)

Manages database connections and entity configurations:

```csharp
using Microsoft.EntityFrameworkCore;
using module6.model;

namespace Data
{
    public class BoardContext : DbContext
    {
        public DbSet<Board> Boards => Set<Board>();
        public DbSet<Todo> Todos => Set<Todo>();

        public BoardContext(DbContextOptions<BoardContext> options)
            : base(options)
        {
            // Constructor accepts options for dependency injection
        }
    }
}
```

**Key Features:**
- **Dependency Injection Ready**: Constructor accepts `DbContextOptions`
- **Modern EF Syntax**: Uses `Set<T>()` method for DbSet properties
- **Multiple Entities**: Manages Boards, Todos, and Users (implicit through navigation)
- **Automatic Configuration**: EF Core infers relationships from navigation properties

## ğŸ”§ Data Service Layer (`DataService.cs`)

Business logic layer that encapsulates data operations:

```csharp
using Microsoft.EntityFrameworkCore;
using System.Text.Json;
using Data;
using module6.model;
using System.Security.Cryptography.X509Certificates;

namespace Service
{
    public class DataService
    {
        private BoardContext db { get; }

        public DataService(BoardContext db)
        {
            this.db = db;
        }

        /// <summary>
        /// Seeds initial data if database is empty
        /// </summary>
        public void SeedData()
        {
            Board board = db.Boards.FirstOrDefault()!;
            if (board == null)
            {
                board = new Board(new List<Todo> { 
                    new Todo("Test1", "Test", new User { Username = "Asger" }) 
                });
                db.Boards.Add(board);
                
                db.Boards.Add(new Board(new List<Todo> { 
                    new Todo("Test2", "Test", new User { Username = "Asger" }) 
                }));
                
                db.Boards.Add(new Board(new List<Todo> { 
                    new Todo("Test3", "Test", new User { Username = "Asger" }) 
                }));
            }
            db.SaveChanges();
        }

        public List<Board> GetBoards()
        {
            return db.Boards.Include(b => b.todos).ToList();
        }
    }
}
```

**Key Features:**
- **Dependency Injection**: Receives DbContext via constructor injection
- **Conditional Seeding**: Only creates data if database is empty
- **Complex Entity Creation**: Creates boards with embedded todos and users in single operation
- **Eager Loading**: Uses `.Include()` to load related todos with boards
- **Business Logic Encapsulation**: Separates data operations from API layer

## ğŸŒ API Configuration (`Program.cs`)

Complete application setup with dependency injection and middleware:

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Http.Json;
using Data;
using Service;

var builder = WebApplication.CreateBuilder(args);

// CORS Configuration for cross-origin requests
var AllowSomeStuff = "_AllowSomeStuff";
builder.Services.AddCors(options =>
{
    options.AddPolicy(name: AllowSomeStuff, builder =>
    {
        builder.AllowAnyOrigin()
               .AllowAnyHeader()
               .AllowAnyMethod();
    });
});

// Database Configuration with SQLite
builder.Services.AddDbContext<BoardContext>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("ContextSQLite")));

// Business Service Registration
builder.Services.AddScoped<DataService>();

var app = builder.Build();

// Automatic Data Seeding on Application Start
using (var scope = app.Services.CreateScope())
{
    var dataService = scope.ServiceProvider.GetRequiredService<DataService>();
    dataService.SeedData();
}

app.UseHttpsRedirection();
app.UseCors(AllowSomeStuff);

// Middleware for setting JSON content type
app.Use(async (context, next) =>
{
    context.Response.ContentType = "application/json; charset=utf-8";
    await next(context);
});

// API Endpoints
app.MapGet("/", (DataService service) =>
{
    return new { message = "Hello World!" };
});

app.MapGet("/api/Boards", (DataService service) =>
{
    return service.GetBoards().Select(a => new { a.BoardId });
});

app.Run();
```

## ğŸ—„ï¸ Database Schema

### Implicit Schema (EF Core Conventions)

Based on the entity models, EF Core creates the following schema:

#### Boards Table
| Column | Type | Constraints |
|--------|------|-------------|
| BoardId | INTEGER | PRIMARY KEY, AUTOINCREMENT |

#### Todos Table
| Column | Type | Constraints |
|--------|------|-------------|
| UserId | INTEGER | PRIMARY KEY |
| Text | TEXT | NULLABLE |
| Category | TEXT | NULLABLE |
| BoardId | INTEGER | FOREIGN KEY (implicit) |

#### Users Table
| Column | Type | Constraints |
|--------|------|-------------|
| UserId | INTEGER | PRIMARY KEY, AUTOINCREMENT |
| Username | TEXT | NULLABLE |

### Entity Relationships
- **Board** (1) â†’ **Todos** (Many)
- **User** (1) â†’ **Todos** (Many)
- **Board** contains multiple **Todos**
- Each **Todo** belongs to one **User**

## âš™ï¸ Configuration Files

### Connection String Configuration

**appsettings.json:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "ContextSQLite": "Data Source=bin/database.db"
  }
}
```

**appsettings.Development.json:**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "ContextSQLite": "Data Source=bin/database.db"
  }
}
```

### Project Dependencies

**module6.csproj:**
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Cors" Version="2.3.0" />
    <PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="7.0.4" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="7.0.4">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SQLite" Version="7.0.4" />
  </ItemGroup>
</Project>
```

## ğŸš€ How to Run

### 1. Prerequisites
```bash
# Install EF Core tools globally (if not already installed)
dotnet tool install --global dotnet-ef
```

### 2. Setup and Run
```bash
# Navigate to module6 directory
cd module6

# Create initial migration (if needed)
dotnet ef migrations add InitialCreate

# Update database
dotnet ef database update

# Run the application
dotnet run
```

### 3. Test the API
```bash
# Test root endpoint
curl http://localhost:5000/

# Expected response:
# {"message":"Hello World!"}

# Test boards endpoint
curl http://localhost:5000/api/Boards

# Expected response:
# [{"boardId":1},{"boardId":2},{"boardId":3}]
```

## ğŸ”‘ Key Design Patterns

### Service Layer Pattern

Separates business logic from API controllers:

```csharp
// Business logic in service
public class DataService
{
    public List<Board> GetBoards() => db.Boards.Include(b => b.todos).ToList();
}

// API layer uses service
app.MapGet("/api/Boards", (DataService service) => service.GetBoards());
```

### Dependency Injection Pattern

Clean separation of concerns through DI:

```csharp
// Service registration
builder.Services.AddScoped<DataService>();

// Constructor injection
public DataService(BoardContext db) => this.db = db;
```

### Data Transfer Object Pattern

API responses use projection to control shape:

```csharp
// Only return needed fields
return service.GetBoards().Select(a => new { a.BoardId });
```

## ğŸ§ª Understanding the Data Flow

### 1. Application Startup
```csharp
// 1. DI container configured
builder.Services.AddDbContext<BoardContext>();
builder.Services.AddScoped<DataService>();

// 2. Data seeding occurs
var dataService = scope.ServiceProvider.GetRequiredService<DataService>();
dataService.SeedData();
```

### 2. Data Seeding Process
```csharp
// Creates complex object graph in single operation
var board = new Board(new List<Todo> { 
    new Todo("Test1", "Test", new User { Username = "Asger" }) 
});
db.Boards.Add(board);  // EF tracks entire object graph
db.SaveChanges();       // Persists boards, todos, and users
```

### 3. API Request Processing
```csharp
// 1. Request hits endpoint
app.MapGet("/api/Boards", (DataService service) => { ... });

// 2. DI provides DataService with DbContext
// 3. Service loads boards with related todos
return db.Boards.Include(b => b.todos).ToList();

// 4. Projection shapes response
.Select(a => new { a.BoardId })
```

## ğŸ§  Advanced Entity Framework Concepts

### Entity Graph Creation

Creating related entities in single operation:

```csharp
// EF Core tracks entire object graph
var board = new Board(new List<Todo> { 
    new Todo("Task 1", "Work", new User { Username = "Alice" }),
    new Todo("Task 2", "Personal", new User { Username = "Bob" })
});
db.Boards.Add(board);  // Adds board, todos, and users
db.SaveChanges();       // Single transaction
```

### Include vs Projection

**Include (Eager Loading):**
```csharp
// Loads all properties of related entities
var boards = db.Boards.Include(b => b.todos).ToList();
```

**Projection (Selective Loading):**
```csharp
// Loads only needed properties
var boardSummary = db.Boards
    .Select(b => new { b.BoardId, TodoCount = b.todos.Count() })
    .ToList();
```

### Change Tracking

EF Core automatically tracks changes:

```csharp
var board = db.Boards.Include(b => b.todos).First();
board.todos.Add(new Todo("New Task", "Urgent", existingUser));
db.SaveChanges();  // EF detects and persists new todo
```

## ğŸ“ Practice Exercises

### Beginner Level

1. **Add Board Name**: Extend Board entity with a Name property
2. **Todo Status**: Add Done/Pending status to todos
3. **User Email**: Add email field to User entity
4. **API Extension**: Create endpoint to get todos by board ID

### Intermediate Level

5. **Todo Priority**: Add priority levels (High, Medium, Low)
6. **Due Dates**: Add deadline tracking for todos
7. **Board Categories**: Add category/type to boards
8. **User Roles**: Implement different user types (Admin, Member)

### Advanced Level

9. **Todo Comments**: Add one-to-many relationship for todo comments
10. **Board Permissions**: Implement user access control per board
11. **Activity Logging**: Track who did what and when
12. **Soft Delete**: Implement logical deletion for todos and boards

### Expert Level

13. **Multi-tenancy**: Support multiple organizations
14. **Event Sourcing**: Track all changes as events
15. **CQRS Pattern**: Separate read and write operations
16. **Performance Optimization**: Implement caching and query optimization

## ğŸ”§ Troubleshooting

### Common Issues

**Migration Creation:**
```bash
# Create new migration
dotnet ef migrations add DescriptiveName

# Apply migrations
dotnet ef database update
```

**Database Reset (Development):**
```bash
# Drop database and recreate
dotnet ef database drop --force
dotnet ef migrations remove
dotnet ef migrations add InitialCreate
dotnet ef database update
```

**Relationship Issues:**
```csharp
// Ensure navigation properties are properly configured
public class Board
{
    public List<Todo> todos { get; set; } = new List<Todo>();  // Initialize collection
}
```

**Include Performance:**
```csharp
// For large datasets, consider projection instead of Include
var boards = db.Boards
    .Select(b => new { b.BoardId, TodoCount = b.todos.Count() })
    .ToList();
```

## ğŸ“Š Database Design Insights

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Board    â”‚       â”‚    Todo     â”‚       â”‚    User     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BoardId (PK)â”‚â—„â”€â”€â”€â”€â”€â”â”‚ UserId (PK) â”‚â”Œâ”€â”€â”€â”€â”€â–ºâ”‚ UserId (PK) â”‚
â”‚             â”‚      â”‚â”‚ Text        â”‚â”‚      â”‚ Username    â”‚
â”‚             â”‚      â”‚â”‚ Category    â”‚â”‚      â”‚             â”‚
â”‚             â”‚      â”‚â”‚ BoardId (FK)â”‚â”‚      â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚               â”‚
                     â”‚  One-to-Many  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Benefits of This Design

- **Hierarchical Organization**: Boards contain related todos
- **User Assignment**: Clear responsibility tracking
- **Scalable**: Easy to add more properties and relationships
- **Flexible**: Supports various project management scenarios

## ğŸ“š Further Reading

- [Entity Framework Core Relationships](https://docs.microsoft.com/en-us/ef/core/modeling/relationships)
- [Dependency Injection in ASP.NET Core](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection)
- [Entity Framework Include Performance](https://docs.microsoft.com/en-us/ef/core/querying/related-data)
- [Service Layer Pattern](https://martinfowler.com/eaaCatalog/serviceLayer.html)
- [Repository Pattern with EF Core](https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design)